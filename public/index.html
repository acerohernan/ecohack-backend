<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ecohack MVP Clasificador de residuos</title>
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        text-align: center;
        background-color: #f4f4f4;
      }

      h1 {
        font-size: 1.8em;
        margin-bottom: 20px;
      }

      input[type="file"] {
        margin-bottom: 10px;
      }

      .botones {
        margin: 10px 0;
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }

      .botones button {
        padding: 12px 20px;
        font-size: 1em;
        width: 90%;
        max-width: 300px;
        border: none;
        border-radius: 5px;
        background-color: #007bff;
        color: white;
        cursor: pointer;
      }

      .botones button:hover {
        background-color: #0056b3;
      }

      canvas,
      video,
      img {
        width: 100%;
        max-width: 100%;
        height: auto;
        margin-top: 20px;
        border-radius: 10px;
      }

      .result {
        background-color: white;
        padding: 15px;
        margin-top: 20px;
        border-radius: 10px;
        text-align: left;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .result h3 {
        margin-top: 0;
      }

      .descargar {
        margin-top: 15px;
      }

      @media (min-width: 600px) {
        .botones {
          flex-direction: row;
          justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <h1>Ecohack MVP Clasificador de residuos</h1>

    <input type="file" id="fileInput" accept="image/*" />
    <div class="botones" id="botones-container">
      <button onclick="enviarImagen()">ðŸ“¤ Clasificar Imagen</button>
      <button onclick="iniciarCamara()">ðŸ“¸ Tomar Foto</button>
    </div>

    <div id="previewContainer"></div>
    <div class="result" id="resultContainer"></div>

    <script>
      let selectedFile = null;
      let stream = null;

      const colorMap = {
        verde: "green",
        marrÃ³n: "brown",
        rojo: "red",
        negro: "black",
        no_clasificado: "gray",
      };

      document
        .getElementById("fileInput")
        .addEventListener("change", function (e) {
          selectedFile = e.target.files[0];

          if (selectedFile) {
            const reader = new FileReader();
            reader.onload = function (event) {
              const img = new Image();
              img.src = event.target.result;

              img.onload = function () {
                const canvas = document.createElement("canvas");
                canvas.width = img.width;
                canvas.height = img.height;
                const ctx = canvas.getContext("2d");

                ctx.drawImage(img, 0, 0);
                const preview = document.getElementById("previewContainer");
                preview.innerHTML = "";
                preview.appendChild(canvas);

                canvas.dataset.loaded = "true";
                window.currentCanvas = canvas;
                window.currentCtx = ctx;
              };
            };
            reader.readAsDataURL(selectedFile);
          }
        });

      let usingFrontCamera = true;

      function iniciarCamara() {
        if (stream) {
          stream.getTracks().forEach((track) => track.stop());
        }

        const constraints = {
          video: {
            facingMode: usingFrontCamera ? "user" : { exact: "environment" },
          },
        };

        navigator.mediaDevices
          .getUserMedia(constraints)
          .then((mediaStream) => {
            stream = mediaStream;

            const video = document.createElement("video");
            video.autoplay = true;
            video.playsInline = true;
            video.srcObject = mediaStream;

            const preview = document.getElementById("previewContainer");
            preview.innerHTML = "";
            preview.appendChild(video);

            // Elimina botones anteriores si existen
            const botones = document.getElementById("botones-container");
            const oldButtons = botones.querySelectorAll(".camara-extra");
            oldButtons.forEach((btn) => btn.remove());

            // BotÃ³n de capturar
            const captureButton = document.createElement("button");
            captureButton.innerText = "ðŸ“· Capturar";
            captureButton.classList.add("camara-extra");
            captureButton.style.marginTop = "10px";
            captureButton.onclick = function () {
              const canvas = document.createElement("canvas");
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              const ctx = canvas.getContext("2d");
              ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

              window.currentCanvas = canvas;
              window.currentCtx = ctx;

              const preview = document.getElementById("previewContainer");
              preview.innerHTML = "";
              preview.appendChild(canvas);

              stream.getTracks().forEach((track) => track.stop());
            };

            // BotÃ³n de cambiar cÃ¡mara
            const switchButton = document.createElement("button");
            switchButton.innerText = "ðŸ”„ Cambiar CÃ¡mara";
            switchButton.classList.add("camara-extra");
            switchButton.style.marginTop = "10px";
            switchButton.onclick = function () {
              usingFrontCamera = !usingFrontCamera;
              iniciarCamara();
            };

            // Agrega los nuevos botones
            botones.appendChild(captureButton);
            botones.appendChild(switchButton);
          })
          .catch((err) => {
            alert("No se pudo acceder a la cÃ¡mara: " + err);
          });
      }

      async function enviarImagen() {
        const resultContainer = document.getElementById("resultContainer");
        resultContainer.innerHTML = "";

        if (!window.currentCanvas) {
          alert("Primero selecciona o captura una imagen");
          return;
        }

        const blob = await new Promise((resolve) =>
          window.currentCanvas.toBlob(resolve, "image/jpeg")
        );

        const formData = new FormData();
        formData.append("file", blob, "captura.jpg");

        const response = await fetch("/clasificar/", {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          alert("Error al clasificar la imagen");
          return;
        }

        const data = await response.json();
        const ctx = window.currentCtx;

        // Asegurar que el canvas estÃ¡ visible
        const preview = document.getElementById("previewContainer");
        preview.innerHTML = "";
        preview.appendChild(window.currentCanvas);

        resultContainer.innerHTML = "<h3>Resultado:</h3>";

        data.resultado.forEach((item) => {
          if (item.residuo !== "no_clasificado") {
            const [x1, y1, x2, y2] = item.bbox;
            const color = colorMap[item.residuo] || "gray";

            ctx.strokeStyle = color;
            ctx.lineWidth = 3;
            ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);

            ctx.fillStyle = color;
            ctx.font = "16px Arial";
            ctx.fillText(
              item.etiqueta + " (" + item.residuo + ")",
              x1 + 5,
              y1 - 5
            );
          }

          resultContainer.innerHTML += `
            <div>
              <strong>${
                item.etiqueta
              }</strong> â†’ ${item.residuo.toUpperCase()}<br>
              <small>UbicaciÃ³n: [${item.bbox
                .map((n) => n.toFixed(0))
                .join(", ")}]</small>
            </div><hr>`;
        });
      }

      function descargarImagen() {
        if (!window.currentCanvas) {
          alert("No hay imagen para descargar");
          return;
        }

        const link = document.createElement("a");
        link.download = "clasificado.jpg";
        link.href = window.currentCanvas.toDataURL("image/jpeg");
        link.click();
      }
    </script>
  </body>
</html>
